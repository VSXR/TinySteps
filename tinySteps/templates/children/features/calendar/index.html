{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Calendar for" %} {{ child.name }} - Tiny Steps{% endblock %}

{% block main_contents %}
    <main id="main-content" class="container-fluid py-4">
        {% csrf_token %}
        <input type="hidden" id="child-id" value="{{ child.id }}">
        
        <!-- Breadcrumbs -->
        {% include "children/components/child_breadcrumbs.html" with child=child feature_type="calendar" %}
        
        <!-- Page Title -->
        {% trans "Calendar for" as calendar_prefix %}
        {% trans "Manage appointments and milestones for" as subtitle_prefix %}
        {% with page_title=calendar_prefix|add:" "|add:child.name page_subtitle=subtitle_prefix|add:" "|add:child.name %}
            {% include "children/components/page_header.html" with title=page_title subtitle=page_subtitle %}
        {% endwith %}

        <!-- Messages Container -->
        <div class="row">
            <div class="col">
                <div id="messages-container" class="messages mb-3" role="alert" aria-live="polite">
                    {% if messages %}
                        {% include 'partials/messages.html' %}
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Main content -->
        <div class="row">
            <!-- Calendar (left) -->
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm rounded-4 mb-4">
                    <div class="card-header bg-light border-0 pt-3">
                        <h2 class="h4 mb-0 d-flex align-items-center">
                            <i class="fa-solid fa-calendar-days text-primary me-2" aria-hidden="true"></i>
                            {% trans "Calendar" %}
                        </h2>
                    </div>
                    <div class="card-body p-3">
                        <!-- Calendar navigation -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <button id="prev-month" class="btn btn-sm btn-outline-secondary rounded-pill calendar-nav-btn">
                                <i class="fa-solid fa-chevron-left me-1" aria-hidden="true"></i> {% trans "Previous" %}
                            </button>
                            <h3 id="current-month-year" class="h5 mb-0 current-month-title">{% now "F Y" %}</h3>
                            <button id="next-month" class="btn btn-sm btn-outline-secondary rounded-pill calendar-nav-btn">
                                {% trans "Next" %} <i class="fa-solid fa-chevron-right ms-1" aria-hidden="true"></i>
                            </button>
                        </div>
                        
                        <!-- Calendar grid -->
                        <div id="calendar-container" class="bg-white rounded-3 calendar-container">
                            <table id="calendar-table" class="table table-bordered">
                                <caption class="visually-hidden">{% trans "Calendar" %}</caption>
                                <thead>
                                    <tr>
                                        <th scope="col">{% trans "Sun" %}</th>
                                        <th scope="col">{% trans "Mon" %}</th>
                                        <th scope="col">{% trans "Tue" %}</th>
                                        <th scope="col">{% trans "Wed" %}</th>
                                        <th scope="col">{% trans "Thu" %}</th>
                                        <th scope="col">{% trans "Fri" %}</th>
                                        <th scope="col">{% trans "Sat" %}</th>
                                    </tr>
                                </thead>
                                <tbody id="calendar-body">
                                    <!-- Calendar days will be generated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Legend -->
                        <div class="mt-3">
                            <div class="d-flex flex-wrap gap-3">
                                <div class="d-flex align-items-center">
                                    <span class="legend-dot bg-primary me-2"></span>
                                    <span>{% trans "Medical" %}</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <span class="legend-dot bg-success me-2"></span>
                                    <span>{% trans "Milestone" %}</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <span class="legend-dot bg-warning me-2"></span>
                                    <span>{% trans "Vaccine" %}</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <span class="legend-dot bg-info me-2"></span>
                                    <span>{% trans "Other" %}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar (right) - Event form and reminders -->
            <div class="col-lg-4">
                <!-- Event form -->
                <div class="card border-0 shadow-sm rounded-4 mb-4">
                    <div class="card-header bg-light border-0 pt-3">
                        <h2 class="h4 mb-0 d-flex align-items-center" id="form-title">
                            <i class="fa-solid fa-plus text-primary me-2" aria-hidden="true"></i>
                            {% trans "Add Event" %}
                        </h2>
                    </div>
                    <div class="card-body">
                        <form id="event-form">
                            <div class="mb-3">
                                <label for="event-title" class="form-label">{% trans "Title" %} <span class="text-danger">*</span></label>
                                <input type="text" class="form-control rounded-pill" id="event-title" required aria-describedby="title-help">
                                <div id="title-help" class="form-text">{% trans "Enter a clear title for the event" %}</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="event-type" class="form-label">{% trans "Event Type" %} <span class="text-danger">*</span></label>
                                <select class="form-select rounded-pill" id="event-type" aria-describedby="type-help" required>
                                    <option value="doctor">{% trans "Medical Appointment" %}</option>
                                    <option value="milestone">{% trans "Milestone" %}</option>
                                    <option value="vaccine">{% trans "Vaccination" %}</option>
                                    <option value="other">{% trans "Other" %}</option>
                                </select>
                                <div id="type-help" class="form-text">{% trans "Select the type of event" %}</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="event-date" class="form-label">{% trans "Date" %} <span class="text-danger">*</span></label>
                                <input type="date" class="form-control rounded-pill" id="event-date" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="event-time" class="form-label">{% trans "Time" %}</label>
                                <input type="time" class="form-control rounded-pill" id="event-time">
                            </div>
                            
                            <div class="mb-3">
                                <label for="event-location" class="form-label">{% trans "Location" %}</label>
                                <input type="text" class="form-control rounded-pill" id="event-location">
                            </div>
                            
                            <div class="mb-3">
                                <label for="event-notes" class="form-label">{% trans "Notes" %}</label>
                                <textarea class="form-control rounded-3" id="event-notes" rows="3"></textarea>
                            </div>
                            
                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="event-reminder">
                                <label class="form-check-label" for="event-reminder">{% trans "Set reminder" %}</label>
                            </div>
                            
                            <div id="reminder-options" class="mb-3" style="display: none;">
                                <label for="reminder-time" class="form-label">{% trans "Remind me" %}</label>
                                <select class="form-select rounded-pill" id="reminder-time">
                                    <option value="30">{% trans "30 minutes before" %}</option>
                                    <option value="60">{% trans "1 hour before" %}</option>
                                    <option value="1440">{% trans "1 day before" %}</option>
                                    <option value="10080">{% trans "1 week before" %}</option>
                                </select>
                            </div>
                            
                            <div class="d-flex flex-column flex-sm-row justify-content-between form-buttons gap-2">
                                <div>
                                    <button type="button" id="btn-delete" class="btn btn-danger rounded-pill px-3" 
                                          aria-label="{% trans 'Delete this event' %}" style="display: none;">
                                        <i class="fa-solid fa-trash-alt me-1" aria-hidden="true"></i> {% trans "Delete" %}
                                    </button>
                                </div>
                                <div class="d-flex flex-column flex-sm-row gap-2">
                                    <button type="button" id="btn-cancel" class="btn btn-outline-secondary rounded-pill px-3" 
                                          aria-label="{% trans 'Cancel event editing' %}" style="display: none;">
                                        {% trans "Cancel" %}
                                    </button>
                                    <button type="submit" id="btn-save" class="btn btn-primary rounded-pill px-4">
                                        <i class="fa-solid fa-check me-1" aria-hidden="true"></i> {% trans "Save Event" %}
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Upcoming reminders -->
                <div class="card border-0 shadow-sm rounded-4 mb-4">
                    <div class="card-header bg-light border-0 d-flex justify-content-between align-items-center pt-3">
                        <h3 class="h5 mb-0 d-flex align-items-center">
                            <i class="fa-solid fa-bell text-primary me-2" aria-hidden="true"></i>
                            {% trans "Reminders" %}
                        </h3>
                        <span class="badge rounded-pill bg-primary" aria-label="{% trans 'Number of reminders:' %} {{ upcoming_reminders|length }}">{{ upcoming_reminders|length }}</span>
                    </div>
                    <ul class="list-group list-group-flush" id="upcoming-reminders" role="list">
                        {% if upcoming_reminders %}
                            {% for reminder in upcoming_reminders %}
                                <li class="list-group-item reminder-item d-flex justify-content-between align-items-start" data-event-id="{{ reminder.id }}">
                                    <div>
                                        <h4 class="h6 mb-1">{{ reminder.title }}</h4>
                                        <p class="small text-muted mb-0 d-flex align-items-center">
                                            <i class="fa-solid fa-calendar-day me-1" aria-hidden="true"></i>
                                            {{ reminder.date|date:"d M Y" }}
                                            {% if reminder.time %}
                                                <span class="mx-1">•</span>
                                                <i class="fa-solid fa-clock me-1" aria-hidden="true"></i>
                                                {{ reminder.time|time:"H:i" }}
                                            {% endif %}
                                        </p>
                                    </div>
                                    <span class="badge event-type-{{ reminder.type }}">{{ reminder.type|title }}</span>
                                </li>
                            {% endfor %}
                        {% else %}
                            <li class="list-group-item text-center py-3" id="no-reminders">
                                <p class="mb-0 text-muted">{% trans "No upcoming reminders" %}</p>
                            </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>

        <!-- Event details modal -->
        <div class="modal fade" id="eventDetailsModal" tabindex="-1" aria-labelledby="eventDetailsModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content rounded-4 border-0 shadow">
                    <div class="modal-header">
                        <h5 class="modal-title" id="eventDetailsModalLabel">{% trans "Event Details" %}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
                    </div>
                    <div class="modal-body" id="event-details-content">
                        <!-- Event details will be inserted here -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary rounded-pill" data-bs-dismiss="modal">{% trans "Close" %}</button>
                        <button type="button" id="btn-edit-event" class="btn btn-primary rounded-pill">
                            <i class="fa-solid fa-pen-to-square me-1" aria-hidden="true"></i> {% trans "Edit Event" %}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Delete confirmation modal -->
        <div class="modal fade" id="deleteEventModal" tabindex="-1" aria-labelledby="deleteEventModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content rounded-4 border-0 shadow">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deleteEventModalLabel">{% trans "Confirm Deletion" %}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
                    </div>
                    <div class="modal-body">
                        {% blocktrans %}Are you sure you want to delete this event? This action cannot be undone.{% endblocktrans %}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary rounded-pill" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                        <button type="button" id="btn-confirm-delete" class="btn btn-danger rounded-pill">
                            <i class="fa-solid fa-trash me-1" aria-hidden="true"></i> {% trans "Delete" %}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notifications -->
        <div id="notification" class="alert position-fixed bottom-0 end-0 m-3 shadow-sm rounded-3" style="display: none; min-width: 300px; z-index: 1050;" role="alert"></div>
    </main>
{% endblock main_contents %}

{% block extra_js %}
    {{ block.super }}
    <script src="{% static 'res/javascript/features/calendar.js' %}"></script>
{% endblock extra_js %}