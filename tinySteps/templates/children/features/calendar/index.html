{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Calendar of" %} {{ child.name }} - TINY STEPS{% endblock %}

{% block extra_css %}
    {{ block.super }}
    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    <link href="{% static 'res/css/calendar.css' %}" rel="stylesheet">
{% endblock extra_css %}

{% block main_contents %}
<main id="main-content" class="container-fluid py-4">
    {% csrf_token %}
    <input type="hidden" id="child-id" value="{{ child.id }}">
    <input type="hidden" id="event-id" value="">

    <!-- Breadcrumb navigation -->
    <nav aria-label="{% trans 'Breadcrumb navigation' %}" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'index' %}">{% trans "Home" %}</a></li>
            <li class="breadcrumb-item"><a href="{% url 'your_children' %}">{% trans "Your Children" %}</a></li>
            <li class="breadcrumb-item"><a href="{% url 'child_detail' child.id %}">{{ child.name }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{% trans "Calendar" %}</li>
        </ol>
    </nav>

    <!-- Page header -->
    <div class="row">
        <div class="col-12">
            <h1 class="text-primary mb-3">{% blocktrans with name=child.name %}Calendar of {{ name }}{% endblocktrans %}</h1>
            <p class="lead text-center mb-4">{% trans "Schedule and manage all your child's important events" %}</p>
        </div>
    </div>

    <!-- Calendar controls -->
    <div class="calendar-controls mb-4">
        <div class="d-flex flex-wrap justify-content-center gap-2 mb-3">
            <div class="calendar-view-buttons btn-group" role="group" aria-label="{% trans 'Change calendar view' %}">
                <button type="button" id="view-month" class="btn btn-outline-primary" aria-pressed="false">{% trans "Month" %}</button>
                <button type="button" id="view-week" class="btn btn-outline-primary" aria-pressed="false">{% trans "Week" %}</button>
                <button type="button" id="view-day" class="btn btn-outline-primary" aria-pressed="false">{% trans "Day" %}</button>
                <button type="button" id="view-list" class="btn btn-outline-primary" aria-pressed="false">{% trans "List" %}</button>
            </div>
            <button type="button" class="btn btn-outline-secondary" id="calendar-today">{% trans "Today" %}</button>
        </div>
    </div>

    <!-- Stats summary -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="stats-card p-3 rounded shadow-sm bg-white">
                <h2 class="h5 mb-3">{% trans "Event summary" %}</h2>
                <div class="event-stats-container d-flex flex-wrap justify-content-around gap-2">
                    <div class="event-stat text-center p-3 rounded flex-grow-1" style="background-color: #4285F4;" aria-label="{% trans 'Medical events:' %} 0" role="status">
                        <div class="event-stat-count fs-3 fw-bold text-white">0</div>
                        <div class="event-stat-label text-white">{% trans "Medical" %}</div>
                    </div>
                    <div class="event-stat text-center p-3 rounded flex-grow-1" style="background-color: #EA4335;" aria-label="{% trans 'Vaccine events:' %} 0" role="status">
                        <div class="event-stat-count fs-3 fw-bold text-white">0</div>
                        <div class="event-stat-label text-white">{% trans "Vaccines" %}</div>
                    </div>
                    <div class="event-stat text-center p-3 rounded flex-grow-1" style="background-color: #FBBC05;" aria-label="{% trans 'Milestone events:' %} 0" role="status">
                        <div class="event-stat-count fs-3 fw-bold text-white">0</div>
                        <div class="event-stat-label text-white">{% trans "Milestones" %}</div>
                    </div>
                    <div class="event-stat text-center p-3 rounded flex-grow-1" style="background-color: #34A853;" aria-label="{% trans 'Feeding events:' %} 0" role="status">
                        <div class="event-stat-count fs-3 fw-bold text-white">0</div>
                        <div class="event-stat-label text-white">{% trans "Feeding" %}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main content: Calendar and Sidebar -->
    <div class="row">
        <!-- Left sidebar with mini-calendar -->
        <div class="col-lg-3">
            <div class="mini-calendar-container bg-white p-3 rounded shadow-sm mb-4">
                <h3 class="h5 mb-3">{% trans "Quick Navigate" %}</h3>
                <div id="mini-calendar"></div>
            </div>
        </div>
        
        <!-- Main calendar -->
        <div class="col-lg-6">
            <div class="calendar-container bg-white p-3 rounded shadow-sm mb-4">
                <div id="calendar" aria-label="{% trans 'Calendar for' %} {{ child.name }}" role="application"></div>
                <div id="calendar-loading" class="d-none text-center mt-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">{% trans "Loading..." %}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right sidebar column -->
        <div class="col-lg-3">
            <div class="event-form-container bg-white p-3 rounded shadow-sm mb-4">
                <h2 id="form-title" class="h4 mb-3 text-primary">{% trans "Add Event" %}</h2>
                <form id="event-form">
                    <div class="mb-3">
                        <label for="event-title" class="form-label">{% trans "Title" %} <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="event-title" required aria-describedby="title-help">
                        <div id="title-help" class="form-text">{% trans "Enter a clear title for the event" %}</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="event-type" class="form-label">{% trans "Event Type" %} <span class="text-danger">*</span></label>
                        <select class="form-select" id="event-type" aria-describedby="type-help" required>
                            <option value="doctor">{% trans "Medical Appointment" %}</option>
                            <option value="vaccine">{% trans "Vaccine" %}</option>
                            <option value="milestone">{% trans "Milestone" %}</option>
                            <option value="feeding">{% trans "Feeding" %}</option>
                            <option value="other">{% trans "Other" %}</option>
                        </select>
                        <div id="type-help" class="form-text">{% trans "Select the type of event" %}</div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6 mb-3 mb-md-0">
                            <label for="event-date" class="form-label">{% trans "Date" %} <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="event-date" required>
                        </div>
                        <div class="col-md-6">
                            <label for="event-time" class="form-label">{% trans "Time" %} ({% trans "optional" %})</label>
                            <input type="time" class="form-control" id="event-time">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="event-description" class="form-label">{% trans "Description" %}</label>
                        <textarea class="form-control" id="event-description" rows="3" aria-describedby="description-help"></textarea>
                        <div id="description-help" class="form-text">{% trans "Add details about the event" %}</div>
                    </div>
                    
                    <div class="mb-3 reminder-container">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="event-reminder">
                            <label class="form-check-label" for="event-reminder">
                                {% trans "Set reminder" %}
                            </label>
                        </div>
                        <div id="reminder-options" class="mt-2" style="display: none;">
                            <label for="reminder-time" class="form-label">{% trans "Remind in advance:" %}</label>
                            <select class="form-select" id="reminder-time">
                                <option value="15">{% trans "15 minutes before" %}</option>
                                <option value="30">{% trans "30 minutes before" %}</option>
                                <option value="60" selected>{% trans "1 hour before" %}</option>
                                <option value="120">{% trans "2 hours before" %}</option>
                                <option value="1440">{% trans "1 day before" %}</option>
                                <option value="2880">{% trans "2 days before" %}</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="d-flex flex-column flex-sm-row justify-content-between form-buttons gap-2">
                        <div>
                            <button type="button" id="btn-delete" class="btn btn-danger w-100 w-sm-auto" aria-label="{% trans 'Delete this event' %}" style="display: none;">
                                <i class="fas fa-trash-alt" aria-hidden="true"></i> {% trans "Delete" %}
                            </button>
                        </div>
                        <div class="d-flex flex-column flex-sm-row gap-2">
                            <button type="button" id="btn-cancel" class="btn btn-outline-secondary" aria-label="{% trans 'Cancel event editing' %}" style="display: none;">
                                {% trans "Cancel" %}
                            </button>
                            <button type="submit" id="btn-save" class="btn btn-primary">
                                {% trans "Save Event" %}
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Upcoming reminders -->
            <div class="card shadow-sm mb-4">
                <div class="card-header d-flex justify-content-between align-items-center bg-light">
                    <h3 class="card-title h5 mb-0">{% trans "Reminders" %}</h3>
                    <span class="badge rounded-pill bg-primary" aria-label="{% trans 'Number of reminders:' %} {{ upcoming_reminders|length }}">{{ upcoming_reminders|length }}</span>
                </div>
                <ul class="list-group list-group-flush" id="upcoming-reminders" role="list">
                    {% if upcoming_reminders %}
                        {% for event in upcoming_reminders %}
                            <li class="list-group-item reminder-item" data-event-id="{{ event.id }}" tabindex="0" role="button" aria-label="{% trans 'Reminder:' %} {{ event.title }} {% trans 'on' %} {{ event.date|date:'d/m/Y' }}{% if event.time %} {% trans 'at' %} {{ event.time|time:'H:i' }}{% endif %}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="badge rounded me-2" style="background-color: 
                                        {% if event.type == 'doctor' %}#4285F4
                                        {% elif event.type == 'vaccine' %}#EA4335
                                        {% elif event.type == 'milestone' %}#FBBC05
                                        {% elif event.type == 'feeding' %}#34A853
                                        {% else %}#8f6ed5{% endif %}">
                                            {% if event.type == 'doctor' %}{% trans "Medical" %}
                                            {% elif event.type == 'vaccine' %}{% trans "Vaccine" %}
                                            {% elif event.type == 'milestone' %}{% trans "Milestone" %}
                                            {% elif event.type == 'feeding' %}{% trans "Feeding" %}
                                            {% else %}{% trans "Other" %}{% endif %}
                                        </span>
                                        <strong>{{ event.title }}</strong>
                                    </div>
                                    <small class="text-muted">
                                        {{ event.date|date:"d/m/Y" }}
                                        {% if event.time %}{{ event.time|time:"H:i" }}{% endif %}
                                    </small>
                                </div>
                                {% if event.description %}
                                <p class="small text-muted mb-0 mt-1">
                                    {{ event.description|truncatechars:100 }}
                                </p>
                                {% endif %}
                            </li>
                        {% endfor %}
                    {% else %}
                        <li class="list-group-item text-center" id="no-upcoming-reminders">{% trans "No upcoming reminders" %}</li>
                    {% endif %}
                </ul>
            </div>

            <!-- Upcoming events -->
            <div class="card shadow-sm mb-4">
                <div class="card-header d-flex justify-content-between align-items-center bg-light">
                    <h3 class="card-title h5 mb-0">{% trans "Upcoming Events" %}</h3>
                    <span class="badge rounded-pill bg-primary" aria-label="{% trans 'Number of upcoming events:' %} {{ upcoming_events|length }}">{{ upcoming_events|length }}</span>
                </div>
                <ul class="list-group list-group-flush" id="upcoming-events" role="list">
                    {% if upcoming_events %}
                        {% for event in upcoming_events %}
                            <li class="list-group-item event-item" data-event-id="{{ event.id }}" tabindex="0" role="button" aria-label="{% trans 'Event:' %} {{ event.title }} {% trans 'on' %} {{ event.date|date:'d/m/Y' }}{% if event.time %} {% trans 'at' %} {{ event.time|time:'H:i' }}{% endif %}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="badge rounded me-2" style="background-color: 
                                        {% if event.type == 'doctor' %}#4285F4
                                        {% elif event.type == 'vaccine' %}#EA4335
                                        {% elif event.type == 'milestone' %}#FBBC05
                                        {% elif event.type == 'feeding' %}#34A853
                                        {% else %}#8f6ed5{% endif %}">
                                            {% if event.type == 'doctor' %}{% trans "Medical" %}
                                            {% elif event.type == 'vaccine' %}{% trans "Vaccine" %}
                                            {% elif event.type == 'milestone' %}{% trans "Milestone" %}
                                            {% elif event.type == 'feeding' %}{% trans "Feeding" %}
                                            {% else %}{% trans "Other" %}{% endif %}
                                        </span>
                                        <strong>{{ event.title }}</strong>
                                    </div>
                                    <small class="text-muted">
                                        {{ event.date|date:"d/m/Y" }}
                                        {% if event.time %}{{ event.time|time:"H:i" }}{% endif %}
                                    </small>
                                </div>
                                {% if event.description %}
                                <p class="small text-muted mb-0 mt-1">
                                    {{ event.description|truncatechars:100 }}
                                </p>
                                {% endif %}
                            </li>
                        {% endfor %}
                    {% else %}
                        <li class="list-group-item text-center" id="no-upcoming-events">{% trans "No upcoming events" %}</li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>

    <!-- Mobile view for event details (for smaller screens) -->
    <div class="d-lg-none">
        <div class="card event-card-mobile d-none shadow-sm mb-4">
            <div class="card-header bg-light">
                <h3 class="card-title h5 mb-0">{% trans "Event Details" %}</h3>
                <button type="button" class="btn-close close-mobile-detail" aria-label="{% trans 'Close event details' %}"></button>
            </div>
            <div class="card-body">
                <div id="mobile-event-details">
                    {% comment %} en proceso {% endcomment %}
                </div>
                <div class="d-flex justify-content-between mt-3">
                    <button class="btn btn-sm btn-danger delete-mobile-event">
                        <i class="fas fa-trash-alt" aria-hidden="true"></i> {% trans "Delete" %}
                    </button>
                    <button class="btn btn-sm btn-primary edit-mobile-event">
                        <i class="fas fa-edit" aria-hidden="true"></i> {% trans "Edit" %}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications -->
    <div id="notification" class="alert position-fixed bottom-0 end-0 m-3" style="display: none; min-width: 300px; z-index: 1050;" role="alert"></div>

    <!-- Delete confirmation modal -->
    <div class="modal fade" id="deleteEventModal" tabindex="-1" aria-labelledby="deleteEventModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteEventModalLabel">{% trans "Confirm Deletion" %}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
                </div>
                <div class="modal-body">
                    {% blocktrans %}Are you sure you want to delete this event? This action cannot be undone.{% endblocktrans %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                    <button type="button" id="btn-confirm-delete" class="btn btn-danger">{% trans "Delete" %}</button>
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock main_contents %}

{% block extra_js %}
    {{ block.super }}
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales-all.min.js"></script>
    <script src="{% static 'res/javascript/features/calendar.js' %}"></script>
{% endblock extra_js %}
