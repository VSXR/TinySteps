{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Vaccination Card of" %} {{ child.name }} - TINY STEPS{% endblock %}

{% block extra_css %}
    {{ block.super }}
    <link href="{% static 'res/css/vaccine-card.css' %}" rel="stylesheet">
{% endblock extra_css %}

{% block main_contents %}
    <main id="main-content" class="container-fluid py-4">
        {% csrf_token %}
        <input type="hidden" id="child-id" value="{{ child.id }}">
        <input type="hidden" id="vaccine-card-id" value="{{ vaccine_card.id }}">
        
        <nav aria-label="{% trans 'Breadcrumb navigation' %}" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'index' %}">{% trans "Home" %}</a></li>
                <li class="breadcrumb-item"><a href="{% url 'your_children' %}">{% trans "Your Children" %}</a></li>
                <li class="breadcrumb-item"><a href="{% url 'child_details' child.id %}">{{ child.name }}</a></li>
                <li class="breadcrumb-item active" aria-current="page">{% trans "Vaccination Card" %}</li>
            </ol>
        </nav>

        <!-- Page header -->
        <div class="row">
            <div class="col-12">
                <h1 class="text-primary mb-3">{% blocktrans with name=child.name %}Vaccination Card of {{ name }}{% endblocktrans %}</h1>
                <p class="lead text-center mb-4">{% trans "Vaccine tracking and upcoming doses" %}</p>
            </div>
        </div>

        <!-- Statistics summary -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="stats-card p-3 rounded shadow-sm bg-white">
                    <h2 class="h5 mb-3">{% trans "Vaccine summary" %}</h2>
                    <div class="vaccine-stats-container d-flex flex-wrap justify-content-around gap-2">
                        <div class="vaccine-stat text-center p-3 rounded flex-grow-1" style="background-color: #4285F4;" aria-label="{% trans 'Total vaccines:' %} {{ total_vaccines }}" role="status">
                            <div class="vaccine-stat-count fs-3 fw-bold text-white">{{ total_vaccines }}</div>
                            <div class="vaccine-stat-label text-white">{% trans "Total Vaccines" %}</div>
                        </div>
                        <div class="vaccine-stat text-center p-3 rounded flex-grow-1" style="background-color: #34A853;" aria-label="{% trans 'Administered vaccines:' %} {{ administered_vaccines }}" role="status">
                            <div class="vaccine-stat-count fs-3 fw-bold text-white">{{ administered_vaccines }}</div>
                            <div class="vaccine-stat-label text-white">{% trans "Administered" %}</div>
                        </div>
                        <div class="vaccine-stat text-center p-3 rounded flex-grow-1" style="background-color: #FBBC05;" aria-label="{% trans 'Pending vaccines:' %} {{ pending_vaccines }}" role="status">
                            <div class="vaccine-stat-count fs-3 fw-bold text-white">{{ pending_vaccines }}</div>
                            <div class="vaccine-stat-label text-white">{% trans "Pending" %}</div>
                        </div>
                        <div class="vaccine-stat text-center p-3 rounded flex-grow-1" style="background-color: #EA4335;" aria-label="{% trans 'Upcoming vaccines:' %} {{ upcoming_vaccines }}" role="status">
                            <div class="vaccine-stat-count fs-3 fw-bold text-white">{{ upcoming_vaccines }}</div>
                            <div class="vaccine-stat-label text-white">{% trans "Upcoming this month" %}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main content -->
        <div class="row">
            <!-- Vaccine list (left) -->
            <div class="col-lg-8">
                <div class="vaccine-list-section bg-white p-3 rounded shadow-sm mb-4">
                    <h2 class="h4 mb-4 text-center">{% trans "Vaccine Registry" %}</h2>

                    <!-- Search and filter controls -->
                    <div class="vaccine-controls mb-4">
                        <div class="input-group mb-3">
                            <input type="text" id="vaccine-search" class="form-control" placeholder="{% trans 'Search vaccine...' %}" aria-label="{% trans 'Search vaccine' %}">
                        </div>
                        <div class="btn-group d-flex flex-wrap justify-content-center" role="group" aria-label="{% trans 'Vaccine filters' %}">
                            <button type="button" id="btn-filter-all" class="btn btn-outline-primary filter-button active" aria-pressed="true">{% trans "All" %}</button>
                            <button type="button" id="btn-filter-administered" class="btn btn-outline-success filter-button" aria-pressed="false">{% trans "Administered" %}</button>
                            <button type="button" id="btn-filter-pending" class="btn btn-outline-warning filter-button" aria-pressed="false">{% trans "Pending" %}</button>
                        </div>
                    </div>

                    <!-- Vaccine table for medium and large screens -->
                    <div class="table-responsive d-none d-md-block" role="region" aria-label="{% trans 'Vaccine list' %}">
                        <table class="table table-hover">
                            <caption class="visually-hidden">{% blocktrans with name=child.name %}Vaccine list for {{ name }}{% endblocktrans %}</caption>
                            <thead>
                                <tr>
                                    <th scope="col">{% trans "Name" %}</th>
                                    <th scope="col">{% trans "Date" %}</th>
                                    <th scope="col">{% trans "Administered" %}</th>
                                    <th scope="col">{% trans "Next Dose" %}</th>
                                    <th scope="col">{% trans "Actions" %}</th>
                                </tr>
                            </thead>
                            <tbody id="vaccine-list-desktop">
                                {% if vaccines %}
                                    {% for vaccine in vaccines %}
                                        <tr class="vaccine-row" data-vaccine-id="{{ vaccine.id }}" tabindex="0" role="button" aria-label="{% trans 'Vaccine:' %} {{ vaccine.name }}">
                                            <td>{{ vaccine.name }}</td>
                                            <td>{{ vaccine.date|date:"d/m/Y" }}</td>
                                            <td>{% if vaccine.administered %}{% trans "Yes" %}{% else %}{% trans "No" %}{% endif %}</td>
                                            <td>{% if vaccine.next_dose_date %}{{ vaccine.next_dose_date|date:"d/m/Y" }}{% endif %}</td>
                                            <td>
                                                <button class="btn btn-sm btn-primary btn-edit-vaccine" title="{% trans 'Edit' %}" aria-label="{% trans 'Edit vaccine' %} {{ vaccine.name }}">
                                                    <i class="fas fa-edit" aria-hidden="true"></i>
                                                </button>
                                                <button class="btn btn-sm btn-danger btn-delete-vaccine" title="{% trans 'Delete' %}" aria-label="{% trans 'Delete vaccine' %} {{ vaccine.name }}">
                                                    <i class="fas fa-trash-alt" aria-hidden="true"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="5" class="text-center py-4">
                                            <div class="empty-state">
                                                <h3 class="h5 mb-3">{% trans "No vaccines registered" %}</h3>
                                                <p class="text-muted mb-3">{% blocktrans with name=child.name %}Start recording {{ name }}'s vaccines{% endblocktrans %}</p>
                                                <button id="btn-add-first-vaccine-desktop" class="btn btn-primary">
                                                    <i class="fas fa-plus" aria-hidden="true"></i> {% trans "Add First Vaccine" %}
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Card view for mobile devices -->
                    <div class="vaccine-cards d-md-none" role="region" aria-label="{% trans 'Mobile vaccine list' %}">
                        {% if vaccines %}
                            <div id="vaccine-list-mobile">
                                {% for vaccine in vaccines %}
                                    <div class="card vaccine-card mb-3" data-vaccine-id="{{ vaccine.id }}">
                                        <div class="card-body">
                                            <h3 class="card-title h5">{{ vaccine.name }}</h3>
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="badge {% if vaccine.administered %}bg-success{% else %}bg-warning{% endif %}">
                                                    {% if vaccine.administered %}{% trans "Administered" %}{% else %}{% trans "Pending" %}{% endif %}
                                                </span>
                                                <span class="text-muted small">{{ vaccine.date|date:"d/m/Y" }}</span>
                                            </div>
                                            {% if vaccine.next_dose_date %}
                                            <p class="card-text small mb-2">
                                                <strong>{% trans "Next dose:" %}</strong> {{ vaccine.next_dose_date|date:"d/m/Y" }}
                                            </p>
                                            {% endif %}
                                            <div class="d-flex justify-content-end mt-3">
                                                <button class="btn btn-sm btn-primary btn-edit-vaccine me-2" aria-label="{% trans 'Edit vaccine' %} {{ vaccine.name }}">
                                                    <i class="fas fa-edit" aria-hidden="true"></i> {% trans "Edit" %}
                                                </button>
                                                <button class="btn btn-sm btn-danger btn-delete-vaccine" aria-label="{% trans 'Delete vaccine' %} {{ vaccine.name }}">
                                                    <i class="fas fa-trash-alt" aria-hidden="true"></i> {% trans "Delete" %}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center py-4 empty-state">
                                <h3 class="h5 mb-3">{% trans "No vaccines registered" %}</h3>
                                <p class="text-muted mb-3">{% blocktrans with name=child.name %}Start recording {{ name }}'s vaccines{% endblocktrans %}</p>
                                <button id="btn-add-first-vaccine-mobile" class="btn btn-primary">
                                    <i class="fas fa-plus" aria-hidden="true"></i> {% trans "Add First Vaccine" %}
                                </button>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Sidebar column (right) - Vaccine form -->
            <div class="col-lg-4">
                <div class="vaccine-form-container bg-white p-3 rounded shadow-sm mb-4">
                    <h2 id="form-title" class="h4 mb-3 text-primary">{% trans "Add Vaccine" %}</h2>
                    <form id="vaccine-form">
                        <input type="hidden" id="vaccine-id" value="">
                        
                        <div class="mb-3">
                            <label for="vaccine-name" class="form-label">{% trans "Vaccine Name" %} <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="vaccine-name" required 
                                   aria-describedby="vaccine-name-help">
                            <div id="vaccine-name-help" class="form-text">{% trans "Ex: Hexavalent, MMR, etc." %}</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="vaccine-date" class="form-label">{% trans "Date" %} <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="vaccine-date" required>
                        </div>
                        
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="vaccine-administered">
                            <label class="form-check-label" for="vaccine-administered">{% trans "Vaccine already administered" %}</label>
                        </div>
                        
                        <div class="mb-3">
                            <label for="vaccine-next-dose" class="form-label">{% trans "Next Dose Date" %}</label>
                            <input type="date" class="form-control" id="vaccine-next-dose">
                        </div>
                        
                        <div class="mb-3">
                            <label for="vaccine-notes" class="form-label">{% trans "Notes" %}</label>
                            <textarea class="form-control" id="vaccine-notes" rows="3" 
                                     aria-describedby="vaccine-notes-help"></textarea>
                            <div id="vaccine-notes-help" class="form-text">{% trans "Additional information about the vaccine, reactions, etc." %}</div>
                        </div>
                        
                        <div class="d-flex flex-column flex-sm-row justify-content-between form-buttons gap-2">
                            <div>
                                <button type="button" id="btn-delete" class="btn btn-danger w-100 w-sm-auto" 
                                      aria-label="{% trans 'Delete this vaccine' %}" style="display: none;">
                                    <i class="fas fa-trash-alt" aria-hidden="true"></i> {% trans "Delete" %}
                                </button>
                            </div>
                            <div class="d-flex flex-column flex-sm-row gap-2">
                                <button type="button" id="btn-cancel" class="btn btn-outline-secondary" 
                                      aria-label="{% trans 'Cancel vaccine editing' %}" style="display: none;">
                                    {% trans "Cancel" %}
                                </button>
                                <button type="submit" id="btn-save" class="btn btn-primary">
                                    {% trans "Save Vaccine" %}
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Upcoming vaccines -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center bg-light">
                        <h3 class="card-title h5 mb-0">{% trans "Upcoming Vaccines" %}</h3>
                        <span class="badge rounded-pill bg-primary" aria-label="{% trans 'Number of upcoming vaccines:' %} {{ upcoming_vaccines }}">{{ upcoming_vaccines }}</span>
                    </div>
                    <ul class="list-group list-group-flush" id="upcoming-vaccines-list">
                        {% if upcoming_vaccines_list %}
                            {% for vaccine in upcoming_vaccines_list %}
                                <li class="list-group-item vaccine-item" data-vaccine-id="{{ vaccine.id }}" tabindex="0" role="button" aria-label="{% trans 'Upcoming vaccine:' %} {{ vaccine.name }} {% trans 'on' %} {{ vaccine.next_dose_date|date:'d/m/Y' }}">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <strong>{{ vaccine.name }}</strong>
                                        <small class="text-muted">
                                            {{ vaccine.next_dose_date|date:"d/m/Y" }}
                                        </small>
                                    </div>
                                    {% if vaccine.notes %}
                                    <p class="small text-muted mb-0 mt-1">
                                        {{ vaccine.notes|truncatechars:100 }}
                                    </p>
                                    {% endif %}
                                </li>
                            {% endfor %}
                        {% else %}
                            <li class="list-group-item text-center" id="no-upcoming-vaccines">{% trans "No upcoming vaccines" %}</li>
                        {% endif %}
                    </ul>
                </div>

                <!-- Vaccination guide -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light">
                        <h3 class="card-title h5 mb-0">{% trans "Vaccination Guide" %}</h3>
                    </div>
                    <div class="card-body">
                        <p class="card-text">{% blocktrans with name=child.name %}Check the recommended vaccination schedule according to {{ name }}'s age.{% endblocktrans %}</p>
                        <a href="#" class="btn btn-outline-primary btn-sm w-100 text-center">{% trans "View Recommended Schedule" %}</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notifications -->
        <div id="notification" class="alert position-fixed bottom-0 end-0 m-3" style="display: none; min-width: 300px; z-index: 1050;" role="alert"></div>

        <!-- Delete confirmation modal -->
        <div class="modal fade" id="deleteVaccineModal" tabindex="-1" aria-labelledby="deleteVaccineModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deleteVaccineModalLabel">{% trans "Confirm Deletion" %}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
                    </div>
                    <div class="modal-body">
                        {% blocktrans %}Are you sure you want to delete this vaccine? This action cannot be undone.{% endblocktrans %}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                        <button type="button" id="btn-confirm-delete" class="btn btn-danger">{% trans "Delete" %}</button>
                    </div>
                </div>
            </div>
        </div>
    </main>
{% endblock main_contents %}

{% block extra_js %}
    {{ block.super }}
    <script src="{% static 'res/javascript/features/vaccine-card.js' %}"></script>
{% endblock extra_js %}